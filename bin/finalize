#!/usr/bin/env bash
# usage: bin/finalize <build-dir> <cache-dir> <env-dir>

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
# ENV_DIR=${3:-}   At the moment, we don't need this argument value...

# Throw toys out of pram if any command fails or a variable is unset
set -eu

echo "-----> Start finalize"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Rust Build Settings
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Ensure that at least CARGO_HOME is set correctly
. "$HOME/.cargo/env"

# Default build flags to pass to `cargo build`.
RUST_CARGO_BUILD_PROFILE="release"
RUST_CARGO_BUILD_FLAGS=""

# Import any cargo specific environment variables if present
if [ -f "$BUILD_DIR/RustConfig" ]
then
  . "$BUILD_DIR/RustConfig"
fi

# Write final target directory to the target_bin_dir file
# The release script can then discover the path to the executable by reading this file
echo target/$RUST_CARGO_BUILD_PROFILE > "$BUILD_DIR/target_bin_dir"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Start the build process
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
cd "$BUILD_DIR"

# Direct the Rust compiler output to the cache
export CARGO_TARGET_DIR="$CACHE_DIR/target"

echo "-----> Building application using Cargo"
echo "----->        Build Directory = $BUILD_DIR"
echo "-----> Cargo Target Directory = $CARGO_TARGET_DIR"

# Build the project then copy the binary from the cache back to the source tree
if [ -z "${RUST_CARGO_BUILD_FLAGS}" ]
then
  cargo build --"$RUST_CARGO_BUILD_PROFILE"
else
  cargo build --"$RUST_CARGO_BUILD_PROFILE" "$RUST_CARGO_BUILD_FLAGS"
fi

mkdir -p target/"$RUST_CARGO_BUILD_PROFILE"

# find command for macos testing only
# find "$CARGO_TARGET_DIR/$RUST_CARGO_BUILD_PROFILE" -maxdepth 1 -type f -perm +111 -exec cp -a {} target/"$RUST_CARGO_BUILD_PROFILE" \;

find "$CARGO_TARGET_DIR/$RUST_CARGO_BUILD_PROFILE" -maxdepth 1 -type f -executable -exec cp -a -t target/"$RUST_CARGO_BUILD_PROFILE" {} \;

echo "<----- End finalize"

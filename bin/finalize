#!/usr/bin/env bash
# usage: bin/finalize <build-dir> <cache-dir> <env-dir>

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
# ENV_DIR=${3:-}   At the moment, we don't need this argument value...

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Rust Build Settings
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
VERSION=stable

# Default build flags to pass to `cargo build`.
RUST_CARGO_BUILD_PROFILE="release"
RUST_CARGO_BUILD_FLAGS=""

# Import the toolchain configuration if present
if [ -f "$BUILD_DIR/rust-toolchain" ]
then
  VERSION="$(cat "$BUILD_DIR/rust-toolchain")"
fi

# If your Rust code does not live in the root directory of the repository, specify the pathname in `BUILD_PATH` in the
# `RustConfig` file
BUILD_PATH=""

# Import any cargo specific environment variables if present
if [ -f "$BUILD_DIR/RustConfig" ]
then
  . "$BUILD_DIR/RustConfig"
fi

# Throw toys out of pram if any command fails or a variable is unset
set -eu

# Check our configuration options.
if [ -z ${VERSION+x} ]
then
  >&2 echo "failed: Value for Rust VERSION missing or empty.  Correct this setting in either the rust-toolchain or the RustConfig file"
  exit 1
fi

# Switch to our cache directory.
mkdir -p "$CACHE_DIR"
cd "$CACHE_DIR"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Install/Update Rust toolchain
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if command -v rustup &> /dev/null
then
  echo "-----> Checking for new releases of Rust $VERSION channel"
  # It's possible that $VERSION has changed, or the `stable` channel has updated.
  rustup self update
  rustup update "$VERSION"
  rustup default "$VERSION"
else
  echo "-----> Downloading rustup"
  curl https://sh.rustup.rs -sSf > rustup.sh
  chmod u+x rustup.sh
  echo "-----> Using rustup to install Rust $VERSION channel"
  ./rustup.sh -y --default-toolchain "$VERSION"
  rm rustup.sh

  # Ensure that at least CARGO_HOME is set correctly
  . "$HOME/.cargo/env"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Start the build process
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
cd "$BUILD_DIR/$BUILD_PATH"
echo "-----> Building application using Cargo"

# If an old target directory still exists, throw it away
rm -rf target/

# Direct the Rust compiler output to the cache
export CARGO_TARGET_DIR="$CACHE_DIR/target"

# Build the project then copy the binary from the cache back to the source tree
if [ -z "${RUST_CARGO_BUILD_FLAGS}" ]
then
  cargo build --"$RUST_CARGO_BUILD_PROFILE"
else
  cargo build --"$RUST_CARGO_BUILD_PROFILE" "$RUST_CARGO_BUILD_FLAGS"
fi

mkdir -p target/"$RUST_CARGO_BUILD_PROFILE"
find "$CARGO_TARGET_DIR/$RUST_CARGO_BUILD_PROFILE" -maxdepth 1 -type f -executable -exec cp -a -t target/"$RUST_CARGO_BUILD_PROFILE" {} \;
